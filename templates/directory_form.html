{% csrf_token %}
<!DOCTYPE html>
<html>
<head>
    <title>Редактирование справочника</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<h2 id="form-title">Редактирование записи</h2>

<form id="directory-form">
    <!-- Поля формы будут динамически добавляться сюда -->
</form>

<button class="btn btn-success mt-2" onclick="saveRecord()">Сохранить</button>
<button class="btn btn-secondary mt-2" onclick="window.history.back()">Отмена</button>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Получаем тип справочника и id из URL
const pathParts = window.location.pathname.split('/').filter(Boolean);
const type = pathParts[1]; // statuses, types, categories и т.д.
const id = pathParts[2] || null;

document.getElementById('form-title').innerText = id ? `Редактирование ${type}` : `Создание ${type}`;

const form = document.getElementById('directory-form');

// загрузка данных для редактирования или выбора
async function loadForm() {
    if (type === 'category_sub_links' || type === 'category_type_links') {
        // загружаем категории, подкатегории, типы
        const res = await fetch("/directory/list/");
        const data = await res.json();

        // категория
        const categorySelect = document.createElement("select");
        categorySelect.className = "form-control mb-2";
        categorySelect.id = "category";
        categorySelect.innerHTML = `<option value="">Выберите категорию</option>` +
            data.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
        form.appendChild(categorySelect);

        if (type === 'category_sub_links') {
            // подкатегория
            const subSelect = document.createElement("select");
            subSelect.className = "form-control mb-2";
            subSelect.id = "sub_category";
            subSelect.innerHTML = `<option value="">Выберите подкатегорию</option>` +
                data.sub_categories.map(sc => `<option value="${sc.id}">${sc.name}</option>`).join("");
            form.appendChild(subSelect);
        } else if (type === 'category_type_links') {
            // тип
            const typeSelect = document.createElement("select");
            typeSelect.className = "form-control mb-2";
            typeSelect.id = "t_type";
            typeSelect.innerHTML = `<option value="">Выберите тип</option>` +
                data.types.map(tt => `<option value="${tt.id}">${tt.name}</option>`).join("");
            form.appendChild(typeSelect);
        }

    } else {
        // обычные справочники: просто поле name
        const input = document.createElement("input");
        input.type = "text";
        input.id = "name";
        input.className = "form-control mb-2";
        input.placeholder = "Введите название";
        form.appendChild(input);
    }

    if (id) {
        // загружаем существующую запись
        const res = await fetch(`/directory/${type}/${id}/`);
        const data = await res.json();

        if (type === 'statuses' || type === 'types' || type === 'categories' || type === 'subcategories') {
            document.getElementById("name").value = data.name;
        } else if (type === 'category_sub_links') {
            document.getElementById("category").value = data.category;
            document.getElementById("sub_category").value = data.sub_category;
        } else if (type === 'category_type_links') {
            document.getElementById("category").value = data.category;
            document.getElementById("t_type").value = data.t_type;
        }
    }
}

async function saveRecord() {
    let payload = {};
    if (type === 'statuses' || type === 'types' || type === 'categories' || type === 'subcategories') {
        payload.name = document.getElementById("name").value;
    } else if (type === 'category_sub_links') {
        payload.category = document.getElementById("category").value;
        payload.sub_category = document.getElementById("sub_category").value;
    } else if (type === 'category_type_links') {
        payload.category = document.getElementById("category").value;
        payload.t_type = document.getElementById("t_type").value;
    }

    const url = id ? `/directory/${type}/${id}/` : `/directory/${type}/`;
    const method = id ? "PUT" : "POST";

    const res = await fetch(url, {
        method: method,
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        alert("Сохранено!");
        window.location.href = "/directory/";
    } else {
        alert("Ошибка при сохранении!");
    }
}

loadForm();
</script>

</body>
</html>
