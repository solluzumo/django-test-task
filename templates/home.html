{% csrf_token %}
<!DOCTYPE html>
<html>
<head>
    <title>–§–∏–ª—å—Ç—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<h2>–§–∏–ª—å—Ç—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>

<div>
    <!-- –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è / –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
    <a href="/transaction/edit/" class="btn btn-primary me-2">
        ‚úèÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
    </a>

    <!-- –ø–µ—Ä–µ—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º -->
    <a href="/directory/edit" class="btn btn-secondary">
        üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏
    </a>
</div>

<div class="mt-3">

    <!-- Category -->
    <div class="mb-2">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <input type="text" id="category" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
    </div>

    <!-- Status -->
    <div class="mb-2">
        <label>–°—Ç–∞—Ç—É—Å:</label>
        <input type="text" id="status" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å">
    </div>

    <!-- Type -->
    <div class="mb-2">
        <label>–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</label>
        <input type="text" id="t_type" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø">
    </div>

    <!-- SubCategory -->
    <div class="mb-2">
        <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <input type="text" id="sub_category" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é">
    </div>

    <!-- Dates -->
    <div class="mb-2">
        <label>–î–∞—Ç–∞ —Å:</label>
        <input type="date" id="created_at__gte" class="form-control">
    </div>
    <div class="mb-2">
        <label>–î–∞—Ç–∞ –ø–æ:</label>
        <input type="date" id="created_at__lte" class="form-control">
    </div>

    <button class="btn btn-primary mt-2" onclick="fetchTransactions()">–ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>

</div>

<hr>
<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
<table class="table table-bordered mt-2">
    <thead>
        <tr>
            <th>ID</th>
            <th>–î–∞—Ç–∞</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¢–∏–ø</th>
            <th>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–°—É–º–º–∞</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        </tr>
    </thead>
    <tbody id="transactions_tbl"></tbody>
</table>


<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function fetchTransactions() {
    const payload = {
        filters: {
            "category": document.getElementById("category").value || undefined,
            "status": document.getElementById("status").value || undefined,
            "t_type": document.getElementById("t_type").value || undefined,
            "sub_category": document.getElementById("sub_category").value || undefined,
            "created_at__gte": document.getElementById("created_at__gte").value || undefined,
            "created_at__lte": document.getElementById("created_at__lte").value || undefined,
        },
        order_by: []
    };

    Object.keys(payload.filters).forEach(key => {
        if (!payload.filters[key]) delete payload.filters[key];
    });

    fetch("/transaction/list/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => renderTransactions(data))
    .catch(err => console.error(err));
}

function renderTransactions(data) {
    const tbody = document.getElementById("transactions_tbl");
    tbody.innerHTML = "";

    data.forEach(tx => {
        tbody.innerHTML += `
            <tr id="tx-${tx.id}">
                <td>${tx.id}</td>
                <td>${tx.created_at}</td>
                <td>${tx.category_name}</td>
                <td>${tx.status_name}</td>
                <td>${tx.t_type_name}</td>
                <td>${tx.sub_category_name}</td>
                <td>${tx.money}</td>
                <td>${tx.comment ?? ''}</td>
                <td>
                    <a href="/transaction/edit/${tx.id}" class="btn btn-sm btn-warning">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                </td>
            </tr>
        `;
    });
}

</script>


</body>
</html>
