<!DOCTYPE html>
<html>
<head>
    <title>Создать / редактировать транзакцию</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<h2 id="form_title">Создание транзакции</h2>

<form id="transactionForm" class="mt-4">
    {% csrf_token %}

    <input type="hidden" id="transaction_id" value="{{ transaction.id|default:'' }}">

    <label>Дата:</label>
    <input class="form-control" type="date" id="created_at" value="{{ transaction.created_at|default:'' }}"><br>

    <label>Сумма:</label>
    <input class="form-control" type="number" id="money" value="{{ transaction.money|default:'' }}"><br>

    <label>Комментарий:</label>
    <input class="form-control" type="text" id="comment" value="{{ transaction.comment|default:'' }}"><br>

    <label>Статус:</label>
    <select class="form-select" id="status">
        {% for s in statuses %}
        <option value="{{ s.id }}" {% if transaction.status_id == s.id %}selected{% endif %}>
            {{ s.name }}
        </option>
        {% endfor %}
    </select>

    <br>

    <label>Категория:</label>
    <select class="form-select" id="category" onchange="loadSubCategories()">
        <option value="">-- выберите категорию --</option>
        {% for c in categories %}
        <option value="{{ c.id }}" {% if transaction.category_id == c.id %}selected{% endif %}>
            {{ c.name }}
        </option>
        {% endfor %}
    </select>
    <br>

    <label>Подкатегория:</label>
    <select class="form-select" id="sub_category"></select>
    <br>

    <label>Тип:</label>
    <select class="form-select" id="t_type">
        {% for t in types %}
        <option value="{{ t.id }}" {% if transaction.t_type_id == t.id %}selected{% endif %}>
            {{ t.name }}
        </option>
        {% endfor %}
    </select>

    <br><br>
    <button class="btn btn-success" type="button" onclick="submitForm()">Сохранить</button>
    {% if transaction.id %}
    <button class="btn btn-danger" onclick="deleteTransaction('{{ id }}')">Удалить</button>
    {% endif %}

</form>

<script>
function deleteTransaction(id) {
    if (!confirm("Вы уверены, что хотите удалить эту транзакцию?")) {
        return;
    }

    fetch(`/transaction/detail/${id}/`, {
        method: "DELETE",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => {
        if (res.ok) {
            alert("Удалено!");
            window.location.href = "/";
        } else {
            res.json().then(err => alert("Ошибка: " + JSON.stringify(err)));
        }
    })
    .catch(err => console.error(err));
}


function loadSubCategories() {
    const categoryId = document.getElementById("category").value;
    const subCatSelect = document.getElementById("sub_category");

    if (!categoryId) {
        subCatSelect.innerHTML = "";
        return;
    }

    fetch(`/directory/get-subcategories/${categoryId}/`)
        .then(res => res.json())
        .then(data => {
            subCatSelect.innerHTML = "";

            data.forEach(item => {
                subCatSelect.innerHTML += `
                    <option value="${item.sub_category__id}">${item.sub_category__name}</option>
                `;
            });
        });
}


function submitForm() {
    const id = document.getElementById("transaction_id").value;
    const payload = {
        "created_at": document.getElementById("created_at").value,
        "money": document.getElementById("money").value,
        "comment": document.getElementById("comment").value,
        "status": document.getElementById("status").value,
        "category": document.getElementById("category").value,
        "sub_category": document.getElementById("sub_category").value,
        "t_type": document.getElementById("t_type").value,
    };

    const url = id
    ? `/transaction/detail/${id}/`
    : `/transaction/detail/`;

    const method = id ? "PUT" : "POST";   // ✅ Меняем HTTP метод

    fetch(url, {
        method: method,
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(payload)
    })
    .then(res => {
        if (res.ok) {
            alert(id ? "Изменения сохранены!" : "Запись создана!");
            window.location.href = "/";
        } else {
            return res.json().then(data => {
                alert("Ошибка: " + JSON.stringify(data));
            });
        }
    })
    .catch(err => console.error(err));

}
</script>
</body>
</html>
